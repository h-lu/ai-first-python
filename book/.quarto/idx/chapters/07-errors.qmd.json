{"title":"错误处理与健壮性","markdown":{"headingText":"错误处理与健壮性","headingAttr":{"id":"sec-errors","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\n::: {.callout-note}\n## 本章概要\n- **课时**：2课时（第7周）\n- **目标**：理解异常处理，让程序更加健壮\n:::\n\n## 学习目标\n\n完成本章后，你将能够：\n\n1. 理解程序为什么会崩溃\n2. 掌握异常处理的基本用法\n3. 用 AI 预判和处理潜在错误\n\n---\n\n## 程序为什么会崩溃？\n\n### 错误是不可避免的\n\n```{mermaid}\nmindmap\n  root((程序错误))\n    用户输入\n      输入为空\n      格式错误\n      超出范围\n    外部资源\n      文件不存在\n      网络断开\n      权限不足\n    逻辑问题\n      除以零\n      索引越界\n      类型不匹配\n    环境问题\n      依赖缺失\n      版本不兼容\n```\n\n### 常见错误类型\n\n```{python}\n#| eval: false\n# 1. FileNotFoundError - 文件不存在\nwith open(\"不存在的文件.txt\") as f:\n    content = f.read()\n\n# 2. ZeroDivisionError - 除以零\nresult = 10 / 0\n\n# 3. TypeError - 类型不匹配\nresult = \"hello\" + 5\n\n# 4. KeyError - 字典键不存在\ndata = {\"name\": \"张三\"}\nprint(data[\"age\"])\n\n# 5. IndexError - 索引越界\nnums = [1, 2, 3]\nprint(nums[10])\n\n# 6. ValueError - 值不合法\nnum = int(\"abc\")\n```\n\n### 错误速查表\n\n| 错误类型 | 原因 | 示例 |\n|---------|------|------|\n| `FileNotFoundError` | 文件不存在 | `open(\"不存在.txt\")` |\n| `ZeroDivisionError` | 除以零 | `10 / 0` |\n| `TypeError` | 类型不匹配 | `\"hello\" + 5` |\n| `KeyError` | 字典键不存在 | `d[\"不存在的键\"]` |\n| `IndexError` | 列表越界 | `[1,2,3][10]` |\n| `ValueError` | 值不合法 | `int(\"abc\")` |\n| `AttributeError` | 属性不存在 | `None.split()` |\n\n---\n\n## 异常处理：try-except\n\n### 基本语法\n\n```{mermaid}\nflowchart TD\n    A[\"try:\"] --> B[\"可能出错的代码\"]\n    B --> C{\"发生错误？\"}\n    C -->|是| D[\"except:\"]\n    D --> E[\"处理错误\"]\n    C -->|否| F[\"else:（可选）\"]\n    F --> G[\"没出错时执行\"]\n    E --> H[\"finally:（可选）\"]\n    G --> H\n    H --> I[\"无论如何都执行\"]\n```\n\n```{python}\n#| eval: true\ndef safe_divide(a, b):\n    \"\"\"安全除法\"\"\"\n    try:\n        result = a / b\n    except ZeroDivisionError:\n        print(\"错误：除数不能为零\")\n        return None\n    else:\n        print(\"计算成功\")\n        return result\n    finally:\n        print(\"计算完成\")  # 无论如何都执行\n\nprint(safe_divide(10, 2))\nprint(\"---\")\nprint(safe_divide(10, 0))\n```\n\n### 捕获多种错误\n\n```{python}\n#| eval: true\ndef safe_get_value(data, key, index=None):\n    \"\"\"安全获取值\"\"\"\n    try:\n        value = data[key]\n        if index is not None:\n            value = value[index]\n        return value\n    except KeyError:\n        return f\"键 '{key}' 不存在\"\n    except IndexError:\n        return f\"索引 {index} 越界\"\n    except TypeError:\n        return \"类型错误\"\n\ndata = {\"scores\": [85, 90, 78]}\n\nprint(safe_get_value(data, \"scores\", 0))   # 85\nprint(safe_get_value(data, \"name\"))        # 键 'name' 不存在\nprint(safe_get_value(data, \"scores\", 10))  # 索引 10 越界\n```\n\n### 获取错误信息\n\n```{python}\n#| eval: true\ndef parse_number(text):\n    \"\"\"解析数字\"\"\"\n    try:\n        return int(text)\n    except ValueError as e:\n        print(f\"无法解析 '{text}': {e}\")\n        return None\n\nprint(parse_number(\"123\"))\nprint(parse_number(\"abc\"))\n```\n\n---\n\n## 让 AI 预判潜在错误\n\n### Prompt 技巧\n\n```\n审查这段代码，列出所有可能发生的错误，并添加适当的异常处理：\n\n[粘贴代码]\n```\n\n### 案例：让 AI 加固代码\n\n**原始代码**：\n```python\ndef get_student_score(students, student_id):\n    return students[student_id]['score']\n```\n\n**Prompt**：\n```\n这个函数可能有哪些问题？帮我加固代码。\n```\n\n**AI 加固后**：\n\n```{python}\n#| eval: true\ndef get_student_score(students, student_id):\n    \"\"\"\n    安全获取学生成绩\n    \n    Returns:\n        成绩值，如果获取失败返回 None\n    \"\"\"\n    # 检查 students 是否为 None\n    if students is None:\n        print(\"错误：学生数据为空\")\n        return None\n    \n    # 检查 student_id 是否存在\n    if student_id not in students:\n        print(f\"错误：学生 {student_id} 不存在\")\n        return None\n    \n    student = students[student_id]\n    \n    # 检查 score 字段是否存在\n    if 'score' not in student:\n        print(f\"错误：学生 {student_id} 没有成绩记录\")\n        return None\n    \n    return student['score']\n\n# 测试\nstudents = {\n    \"001\": {\"name\": \"张三\", \"score\": 85},\n    \"002\": {\"name\": \"李四\"}  # 故意缺少 score\n}\n\nprint(get_student_score(students, \"001\"))  # 85\nprint(get_student_score(students, \"003\"))  # 不存在\nprint(get_student_score(students, \"002\"))  # 没有成绩\nprint(get_student_score(None, \"001\"))      # 数据为空\n```\n\n---\n\n## 防御式编程\n\n### 输入验证\n\n```{mermaid}\nflowchart LR\n    A[\"用户输入\"] --> B{\"验证\"}\n    B -->|有效| C[\"处理\"]\n    B -->|无效| D[\"返回错误\"]\n    C --> E[\"返回结果\"]\n```\n\n### 实践原则\n\n| 原则 | 说明 | 示例 |\n|-----|------|------|\n| **假设输入有问题** | 总是验证输入 | 检查是否为 None |\n| **快速失败** | 早发现早报错 | 在函数开头验证 |\n| **明确错误信息** | 帮助调试 | 说明哪里出错 |\n| **提供默认值** | 优雅降级 | 返回默认值而非崩溃 |\n\n### 验证函数模板\n\n```{python}\n#| eval: true\ndef process_scores(scores):\n    \"\"\"\n    处理成绩列表\n    \n    Args:\n        scores: 成绩列表\n        \n    Returns:\n        平均分，如果无法计算返回 None\n        \n    Raises:\n        ValueError: 当包含无效成绩时\n    \"\"\"\n    # 1. 验证输入不为空\n    if not scores:\n        print(\"警告：成绩列表为空\")\n        return None\n    \n    # 2. 验证类型\n    if not isinstance(scores, (list, tuple)):\n        raise TypeError(\"scores 必须是列表或元组\")\n    \n    # 3. 验证每个元素\n    valid_scores = []\n    for i, score in enumerate(scores):\n        if not isinstance(score, (int, float)):\n            print(f\"警告：第 {i+1} 个成绩无效，跳过\")\n            continue\n        if score < 0 or score > 100:\n            print(f\"警告：成绩 {score} 超出范围，跳过\")\n            continue\n        valid_scores.append(score)\n    \n    # 4. 检查是否有有效数据\n    if not valid_scores:\n        print(\"错误：没有有效成绩\")\n        return None\n    \n    return sum(valid_scores) / len(valid_scores)\n\n# 测试\nprint(process_scores([85, 90, 78]))          # 正常\nprint(process_scores([85, \"无效\", 78]))       # 有无效值\nprint(process_scores([85, 150, 78]))          # 有超范围值\nprint(process_scores([]))                     # 空列表\n```\n\n---\n\n## 文件操作的错误处理\n\n文件操作是最容易出错的地方之一：\n\n```{python}\n#| eval: true\nfrom pathlib import Path\n\ndef safe_read_file(filepath):\n    \"\"\"安全读取文件\"\"\"\n    path = Path(filepath)\n    \n    # 检查文件是否存在\n    if not path.exists():\n        print(f\"错误：文件不存在 - {filepath}\")\n        return None\n    \n    # 检查是否是文件（不是目录）\n    if not path.is_file():\n        print(f\"错误：不是文件 - {filepath}\")\n        return None\n    \n    # 尝试读取\n    try:\n        return path.read_text(encoding=\"utf-8\")\n    except UnicodeDecodeError:\n        try:\n            return path.read_text(encoding=\"gbk\")\n        except UnicodeDecodeError:\n            print(f\"错误：无法解码文件 - {filepath}\")\n            return None\n    except PermissionError:\n        print(f\"错误：没有读取权限 - {filepath}\")\n        return None\n    except Exception as e:\n        print(f\"错误：读取失败 - {e}\")\n        return None\n\n# 测试\ncontent = safe_read_file(\"不存在的文件.txt\")\nprint(f\"结果: {content}\")\n```\n\n---\n\n## 错误日志记录\n\n在实际项目中，应该记录错误而不是只打印：\n\n```{python}\n#| eval: false\nimport logging\n\n# 配置日志\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(levelname)s - %(message)s',\n    filename='app.log'\n)\n\ndef process_data(data):\n    try:\n        result = do_something(data)\n        logging.info(f\"处理成功: {data}\")\n        return result\n    except Exception as e:\n        logging.error(f\"处理失败: {data}, 错误: {e}\")\n        return None\n```\n\n---\n\n## 课后作业\n\n### 完成作业 3：文件批量处理工具\n\n**本周任务**：处理 Edge 测试\n\n1. `test_file_hidden_files`: 隐藏文件处理\n2. `test_file_no_extension`: 无扩展名文件\n3. `test_file_duplicate_name`: 重命名冲突处理\n4. `test_file_permission_error`: 无权限文件跳过\n\n**REPORT.md 要求**：\n- 展示你的 Prompt 如何描述\"重命名冲突\"这个需求\n- 对比 AI 第一次生成的代码和你最终版本的差异\n\n**提交截止**：本周日\n\n---\n\n## 本章小结\n\n- **错误不可避免**：用户输入、外部资源、逻辑问题都可能导致错误\n- **try-except** 是处理错误的基本工具\n- **防御式编程**：假设输入有问题，提前验证\n- **快速失败**：在函数开头验证，早发现早处理\n- **明确错误信息**：帮助调试和定位问题\n- **让 AI 帮忙**：让 AI 审查代码，发现潜在问题\n\n```{mermaid}\nflowchart LR\n    A[\"写代码\"] --> B[\"让 AI 审查\"]\n    B --> C[\"添加错误处理\"]\n    C --> D[\"测试边界情况\"]\n    D --> E[\"健壮的程序\"]\n```\n\n下一章，我们将进入**数据科学工具链**——接触真正的数据分析。\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"jupyter"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":false,"toc-depth":3,"number-sections":true,"highlight-style":{"light":"github","dark":"dracula"},"output-file":"07-errors.html"},"language":{"toc-title-document":"目录","toc-title-website":"该页面内容","related-formats-title":"其他格式","related-notebooks-title":"笔记本","source-notebooks-prefix":"资源","other-links-title":"其他链接","code-links-title":"代码链接","launch-dev-container-title":"启动 Dev Container","launch-binder-title":"启动 Binder","article-notebook-label":"文章笔记本","notebook-preview-download":"下载笔记本","notebook-preview-download-src":"下载源代码","notebook-preview-back":"返回文章","manuscript-meca-bundle":"MECA 存档","section-title-abstract":"摘要","section-title-appendices":"附录","section-title-footnotes":"脚注","section-title-references":"参考文献","section-title-reuse":"二次使用","section-title-copyright":"版权","section-title-citation":"引用格式","appendix-attribution-cite-as":"请按如下格式引用：","appendix-attribution-bibtex":"BibTeX","appendix-view-license":"查看许可协议","title-block-author-single":"作者","title-block-author-plural":"作者","title-block-affiliation-single":"单位","title-block-affiliation-plural":"单位","title-block-published":"发布于","title-block-modified":"修改于","title-block-keywords":"关键词","callout-tip-title":"提示","callout-note-title":"注记","callout-warning-title":"警告","callout-important-title":"重要","callout-caution-title":"注意","code-summary":"代码","code-tools-menu-caption":"代码","code-tools-show-all-code":"显示所有代码","code-tools-hide-all-code":"隐藏所有代码","code-tools-view-source":"查看源代码","code-tools-source-code":"源代码","tools-share":"Share","tools-download":"Download","code-line":"行","code-lines":"行","copy-button-tooltip":"复制到剪贴板","copy-button-tooltip-success":"已复制","repo-action-links-edit":"编辑该页面","repo-action-links-source":"查看代码","repo-action-links-issue":"反馈问题","back-to-top":"回到顶部","search-no-results-text":"没有结果","search-matching-documents-text":"匹配的文档","search-copy-link-title":"复制搜索链接","search-hide-matches-text":"隐藏其它匹配结果","search-more-match-text":"更多匹配结果","search-more-matches-text":"更多匹配结果","search-clear-button-title":"清除","search-text-placeholder":"","search-detached-cancel-button-title":"取消","search-submit-button-title":"提交","search-label":"搜索","toggle-section":"展开或折叠此栏","toggle-sidebar":"展开或折叠侧边栏导航","toggle-dark-mode":"切换深色模式","toggle-reader-mode":"切换阅读器模式","toggle-navigation":"展开或折叠导航栏","crossref-fig-title":"图","crossref-tbl-title":"表","crossref-lst-title":"列表","crossref-thm-title":"定理","crossref-lem-title":"引理","crossref-cor-title":"推论","crossref-prp-title":"命题","crossref-cnj-title":"猜想","crossref-def-title":"定义","crossref-exm-title":"例","crossref-exr-title":"习题","crossref-ch-prefix":"章节","crossref-apx-prefix":"附录","crossref-sec-prefix":"小节","crossref-eq-prefix":"式","crossref-lof-title":"图索引","crossref-lot-title":"表索引","crossref-lol-title":"列表索引","environment-proof-title":"证","environment-remark-title":"注记","environment-solution-title":"解","listing-page-order-by":"排序方式","listing-page-order-by-default":"默认","listing-page-order-by-date-asc":"日期升序","listing-page-order-by-date-desc":"日期降序","listing-page-order-by-number-desc":"降序","listing-page-order-by-number-asc":"升序","listing-page-field-date":"日期","listing-page-field-title":"标题","listing-page-field-description":"描述","listing-page-field-author":"作者","listing-page-field-filename":"文件名","listing-page-field-filemodified":"修改时间","listing-page-field-subtitle":"副标题","listing-page-field-readingtime":"阅读时间","listing-page-field-wordcount":"字数统计","listing-page-field-categories":"分类","listing-page-minutes-compact":"{0} 分钟","listing-page-category-all":"全部","listing-page-no-matches":"无匹配项","listing-page-words":"{0} 字","listing-page-filter":"筛选","draft":"草稿"},"metadata":{"lang":"zh","fig-responsive":true,"quarto-version":"1.8.14","bibliography":["../references.bib"],"theme":{"light":["cosmo","../theme.scss"],"dark":["darkly","../theme.scss"]},"code-copy":true,"number-depth":2,"smooth-scroll":true,"mermaid":{"theme":"neutral","mermaid-format":"svg"}},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"jupyter"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"lualatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","toc":true,"number-sections":true,"output-file":"07-errors.pdf"},"language":{"toc-title-document":"目录","toc-title-website":"该页面内容","related-formats-title":"其他格式","related-notebooks-title":"笔记本","source-notebooks-prefix":"资源","other-links-title":"其他链接","code-links-title":"代码链接","launch-dev-container-title":"启动 Dev Container","launch-binder-title":"启动 Binder","article-notebook-label":"文章笔记本","notebook-preview-download":"下载笔记本","notebook-preview-download-src":"下载源代码","notebook-preview-back":"返回文章","manuscript-meca-bundle":"MECA 存档","section-title-abstract":"摘要","section-title-appendices":"附录","section-title-footnotes":"脚注","section-title-references":"参考文献","section-title-reuse":"二次使用","section-title-copyright":"版权","section-title-citation":"引用格式","appendix-attribution-cite-as":"请按如下格式引用：","appendix-attribution-bibtex":"BibTeX","appendix-view-license":"查看许可协议","title-block-author-single":"作者","title-block-author-plural":"作者","title-block-affiliation-single":"单位","title-block-affiliation-plural":"单位","title-block-published":"发布于","title-block-modified":"修改于","title-block-keywords":"关键词","callout-tip-title":"提示","callout-note-title":"注记","callout-warning-title":"警告","callout-important-title":"重要","callout-caution-title":"注意","code-summary":"代码","code-tools-menu-caption":"代码","code-tools-show-all-code":"显示所有代码","code-tools-hide-all-code":"隐藏所有代码","code-tools-view-source":"查看源代码","code-tools-source-code":"源代码","tools-share":"Share","tools-download":"Download","code-line":"行","code-lines":"行","copy-button-tooltip":"复制到剪贴板","copy-button-tooltip-success":"已复制","repo-action-links-edit":"编辑该页面","repo-action-links-source":"查看代码","repo-action-links-issue":"反馈问题","back-to-top":"回到顶部","search-no-results-text":"没有结果","search-matching-documents-text":"匹配的文档","search-copy-link-title":"复制搜索链接","search-hide-matches-text":"隐藏其它匹配结果","search-more-match-text":"更多匹配结果","search-more-matches-text":"更多匹配结果","search-clear-button-title":"清除","search-text-placeholder":"","search-detached-cancel-button-title":"取消","search-submit-button-title":"提交","search-label":"搜索","toggle-section":"展开或折叠此栏","toggle-sidebar":"展开或折叠侧边栏导航","toggle-dark-mode":"切换深色模式","toggle-reader-mode":"切换阅读器模式","toggle-navigation":"展开或折叠导航栏","crossref-fig-title":"图","crossref-tbl-title":"表","crossref-lst-title":"列表","crossref-thm-title":"定理","crossref-lem-title":"引理","crossref-cor-title":"推论","crossref-prp-title":"命题","crossref-cnj-title":"猜想","crossref-def-title":"定义","crossref-exm-title":"例","crossref-exr-title":"习题","crossref-ch-prefix":"章节","crossref-apx-prefix":"附录","crossref-sec-prefix":"小节","crossref-eq-prefix":"式","crossref-lof-title":"图索引","crossref-lot-title":"表索引","crossref-lol-title":"列表索引","environment-proof-title":"证","environment-remark-title":"注记","environment-solution-title":"解","listing-page-order-by":"排序方式","listing-page-order-by-default":"默认","listing-page-order-by-date-asc":"日期升序","listing-page-order-by-date-desc":"日期降序","listing-page-order-by-number-desc":"降序","listing-page-order-by-number-asc":"升序","listing-page-field-date":"日期","listing-page-field-title":"标题","listing-page-field-description":"描述","listing-page-field-author":"作者","listing-page-field-filename":"文件名","listing-page-field-filemodified":"修改时间","listing-page-field-subtitle":"副标题","listing-page-field-readingtime":"阅读时间","listing-page-field-wordcount":"字数统计","listing-page-field-categories":"分类","listing-page-minutes-compact":"{0} 分钟","listing-page-category-all":"全部","listing-page-no-matches":"无匹配项","listing-page-words":"{0} 字","listing-page-filter":"筛选","draft":"草稿"},"metadata":{"block-headings":true,"lang":"zh","bibliography":["../references.bib"],"documentclass":"scrreprt","papersize":"a4","colorlinks":true},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}