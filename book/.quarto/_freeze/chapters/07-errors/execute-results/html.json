{
  "hash": "8745c47c72ba96bc6d5ace54637f473c",
  "result": {
    "engine": "jupyter",
    "markdown": "# 错误处理与健壮性 {#sec-errors}\n\n::: {.callout-note}\n## 本章概要\n- **课时**：2课时（第7周）\n- **目标**：理解异常处理，让程序更加健壮\n:::\n\n## 学习目标\n\n完成本章后，你将能够：\n\n1. 理解程序为什么会崩溃\n2. 掌握异常处理的基本用法\n3. 用 AI 预判和处理潜在错误\n\n---\n\n## 程序为什么会崩溃？\n\n### 错误是不可避免的\n\n```{mermaid}\nmindmap\n  root((程序错误))\n    用户输入\n      输入为空\n      格式错误\n      超出范围\n    外部资源\n      文件不存在\n      网络断开\n      权限不足\n    逻辑问题\n      除以零\n      索引越界\n      类型不匹配\n    环境问题\n      依赖缺失\n      版本不兼容\n```\n\n### 常见错误类型\n\n::: {#15e32683 .cell execution_count=1}\n``` {.python .cell-code}\n# 1. FileNotFoundError - 文件不存在\nwith open(\"不存在的文件.txt\") as f:\n    content = f.read()\n\n# 2. ZeroDivisionError - 除以零\nresult = 10 / 0\n\n# 3. TypeError - 类型不匹配\nresult = \"hello\" + 5\n\n# 4. KeyError - 字典键不存在\ndata = {\"name\": \"张三\"}\nprint(data[\"age\"])\n\n# 5. IndexError - 索引越界\nnums = [1, 2, 3]\nprint(nums[10])\n\n# 6. ValueError - 值不合法\nnum = int(\"abc\")\n```\n:::\n\n\n### 错误速查表\n\n| 错误类型 | 原因 | 示例 |\n|---------|------|------|\n| `FileNotFoundError` | 文件不存在 | `open(\"不存在.txt\")` |\n| `ZeroDivisionError` | 除以零 | `10 / 0` |\n| `TypeError` | 类型不匹配 | `\"hello\" + 5` |\n| `KeyError` | 字典键不存在 | `d[\"不存在的键\"]` |\n| `IndexError` | 列表越界 | `[1,2,3][10]` |\n| `ValueError` | 值不合法 | `int(\"abc\")` |\n| `AttributeError` | 属性不存在 | `None.split()` |\n\n---\n\n## 异常处理：try-except\n\n### 基本语法\n\n```{mermaid}\nflowchart TD\n    A[\"try:\"] --> B[\"可能出错的代码\"]\n    B --> C{\"发生错误？\"}\n    C -->|是| D[\"except:\"]\n    D --> E[\"处理错误\"]\n    C -->|否| F[\"else:（可选）\"]\n    F --> G[\"没出错时执行\"]\n    E --> H[\"finally:（可选）\"]\n    G --> H\n    H --> I[\"无论如何都执行\"]\n```\n\n::: {#6c82aebf .cell execution_count=2}\n``` {.python .cell-code}\ndef safe_divide(a, b):\n    \"\"\"安全除法\"\"\"\n    try:\n        result = a / b\n    except ZeroDivisionError:\n        print(\"错误：除数不能为零\")\n        return None\n    else:\n        print(\"计算成功\")\n        return result\n    finally:\n        print(\"计算完成\")  # 无论如何都执行\n\nprint(safe_divide(10, 2))\nprint(\"---\")\nprint(safe_divide(10, 0))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n计算成功\n计算完成\n5.0\n---\n错误：除数不能为零\n计算完成\nNone\n```\n:::\n:::\n\n\n### 捕获多种错误\n\n::: {#b4b7f7ba .cell execution_count=3}\n``` {.python .cell-code}\ndef safe_get_value(data, key, index=None):\n    \"\"\"安全获取值\"\"\"\n    try:\n        value = data[key]\n        if index is not None:\n            value = value[index]\n        return value\n    except KeyError:\n        return f\"键 '{key}' 不存在\"\n    except IndexError:\n        return f\"索引 {index} 越界\"\n    except TypeError:\n        return \"类型错误\"\n\ndata = {\"scores\": [85, 90, 78]}\n\nprint(safe_get_value(data, \"scores\", 0))   # 85\nprint(safe_get_value(data, \"name\"))        # 键 'name' 不存在\nprint(safe_get_value(data, \"scores\", 10))  # 索引 10 越界\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n85\n键 'name' 不存在\n索引 10 越界\n```\n:::\n:::\n\n\n### 获取错误信息\n\n::: {#3ab754fd .cell execution_count=4}\n``` {.python .cell-code}\ndef parse_number(text):\n    \"\"\"解析数字\"\"\"\n    try:\n        return int(text)\n    except ValueError as e:\n        print(f\"无法解析 '{text}': {e}\")\n        return None\n\nprint(parse_number(\"123\"))\nprint(parse_number(\"abc\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n123\n无法解析 'abc': invalid literal for int() with base 10: 'abc'\nNone\n```\n:::\n:::\n\n\n---\n\n## 让 AI 预判潜在错误\n\n### Prompt 技巧\n\n```\n审查这段代码，列出所有可能发生的错误，并添加适当的异常处理：\n\n[粘贴代码]\n```\n\n### 案例：让 AI 加固代码\n\n**原始代码**：\n```python\ndef get_student_score(students, student_id):\n    return students[student_id]['score']\n```\n\n**Prompt**：\n```\n这个函数可能有哪些问题？帮我加固代码。\n```\n\n**AI 加固后**：\n\n::: {#69397b99 .cell execution_count=5}\n``` {.python .cell-code}\ndef get_student_score(students, student_id):\n    \"\"\"\n    安全获取学生成绩\n    \n    Returns:\n        成绩值，如果获取失败返回 None\n    \"\"\"\n    # 检查 students 是否为 None\n    if students is None:\n        print(\"错误：学生数据为空\")\n        return None\n    \n    # 检查 student_id 是否存在\n    if student_id not in students:\n        print(f\"错误：学生 {student_id} 不存在\")\n        return None\n    \n    student = students[student_id]\n    \n    # 检查 score 字段是否存在\n    if 'score' not in student:\n        print(f\"错误：学生 {student_id} 没有成绩记录\")\n        return None\n    \n    return student['score']\n\n# 测试\nstudents = {\n    \"001\": {\"name\": \"张三\", \"score\": 85},\n    \"002\": {\"name\": \"李四\"}  # 故意缺少 score\n}\n\nprint(get_student_score(students, \"001\"))  # 85\nprint(get_student_score(students, \"003\"))  # 不存在\nprint(get_student_score(students, \"002\"))  # 没有成绩\nprint(get_student_score(None, \"001\"))      # 数据为空\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n85\n错误：学生 003 不存在\nNone\n错误：学生 002 没有成绩记录\nNone\n错误：学生数据为空\nNone\n```\n:::\n:::\n\n\n---\n\n## 防御式编程\n\n### 输入验证\n\n```{mermaid}\nflowchart LR\n    A[\"用户输入\"] --> B{\"验证\"}\n    B -->|有效| C[\"处理\"]\n    B -->|无效| D[\"返回错误\"]\n    C --> E[\"返回结果\"]\n```\n\n### 实践原则\n\n| 原则 | 说明 | 示例 |\n|-----|------|------|\n| **假设输入有问题** | 总是验证输入 | 检查是否为 None |\n| **快速失败** | 早发现早报错 | 在函数开头验证 |\n| **明确错误信息** | 帮助调试 | 说明哪里出错 |\n| **提供默认值** | 优雅降级 | 返回默认值而非崩溃 |\n\n### 验证函数模板\n\n::: {#4c0221ab .cell execution_count=6}\n``` {.python .cell-code}\ndef process_scores(scores):\n    \"\"\"\n    处理成绩列表\n    \n    Args:\n        scores: 成绩列表\n        \n    Returns:\n        平均分，如果无法计算返回 None\n        \n    Raises:\n        ValueError: 当包含无效成绩时\n    \"\"\"\n    # 1. 验证输入不为空\n    if not scores:\n        print(\"警告：成绩列表为空\")\n        return None\n    \n    # 2. 验证类型\n    if not isinstance(scores, (list, tuple)):\n        raise TypeError(\"scores 必须是列表或元组\")\n    \n    # 3. 验证每个元素\n    valid_scores = []\n    for i, score in enumerate(scores):\n        if not isinstance(score, (int, float)):\n            print(f\"警告：第 {i+1} 个成绩无效，跳过\")\n            continue\n        if score < 0 or score > 100:\n            print(f\"警告：成绩 {score} 超出范围，跳过\")\n            continue\n        valid_scores.append(score)\n    \n    # 4. 检查是否有有效数据\n    if not valid_scores:\n        print(\"错误：没有有效成绩\")\n        return None\n    \n    return sum(valid_scores) / len(valid_scores)\n\n# 测试\nprint(process_scores([85, 90, 78]))          # 正常\nprint(process_scores([85, \"无效\", 78]))       # 有无效值\nprint(process_scores([85, 150, 78]))          # 有超范围值\nprint(process_scores([]))                     # 空列表\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n84.33333333333333\n警告：第 2 个成绩无效，跳过\n81.5\n警告：成绩 150 超出范围，跳过\n81.5\n警告：成绩列表为空\nNone\n```\n:::\n:::\n\n\n---\n\n## 文件操作的错误处理\n\n文件操作是最容易出错的地方之一：\n\n::: {#e8d8188e .cell execution_count=7}\n``` {.python .cell-code}\nfrom pathlib import Path\n\ndef safe_read_file(filepath):\n    \"\"\"安全读取文件\"\"\"\n    path = Path(filepath)\n    \n    # 检查文件是否存在\n    if not path.exists():\n        print(f\"错误：文件不存在 - {filepath}\")\n        return None\n    \n    # 检查是否是文件（不是目录）\n    if not path.is_file():\n        print(f\"错误：不是文件 - {filepath}\")\n        return None\n    \n    # 尝试读取\n    try:\n        return path.read_text(encoding=\"utf-8\")\n    except UnicodeDecodeError:\n        try:\n            return path.read_text(encoding=\"gbk\")\n        except UnicodeDecodeError:\n            print(f\"错误：无法解码文件 - {filepath}\")\n            return None\n    except PermissionError:\n        print(f\"错误：没有读取权限 - {filepath}\")\n        return None\n    except Exception as e:\n        print(f\"错误：读取失败 - {e}\")\n        return None\n\n# 测试\ncontent = safe_read_file(\"不存在的文件.txt\")\nprint(f\"结果: {content}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n错误：文件不存在 - 不存在的文件.txt\n结果: None\n```\n:::\n:::\n\n\n---\n\n## 错误日志记录\n\n在实际项目中，应该记录错误而不是只打印：\n\n::: {#9c47f5d8 .cell execution_count=8}\n``` {.python .cell-code}\nimport logging\n\n# 配置日志\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(levelname)s - %(message)s',\n    filename='app.log'\n)\n\ndef process_data(data):\n    try:\n        result = do_something(data)\n        logging.info(f\"处理成功: {data}\")\n        return result\n    except Exception as e:\n        logging.error(f\"处理失败: {data}, 错误: {e}\")\n        return None\n```\n:::\n\n\n---\n\n## 课后作业\n\n### 完成作业 3：文件批量处理工具\n\n**本周任务**：处理 Edge 测试\n\n1. `test_file_hidden_files`: 隐藏文件处理\n2. `test_file_no_extension`: 无扩展名文件\n3. `test_file_duplicate_name`: 重命名冲突处理\n4. `test_file_permission_error`: 无权限文件跳过\n\n**REPORT.md 要求**：\n- 展示你的 Prompt 如何描述\"重命名冲突\"这个需求\n- 对比 AI 第一次生成的代码和你最终版本的差异\n\n**提交截止**：本周日\n\n---\n\n## 本章小结\n\n- **错误不可避免**：用户输入、外部资源、逻辑问题都可能导致错误\n- **try-except** 是处理错误的基本工具\n- **防御式编程**：假设输入有问题，提前验证\n- **快速失败**：在函数开头验证，早发现早处理\n- **明确错误信息**：帮助调试和定位问题\n- **让 AI 帮忙**：让 AI 审查代码，发现潜在问题\n\n```{mermaid}\nflowchart LR\n    A[\"写代码\"] --> B[\"让 AI 审查\"]\n    B --> C[\"添加错误处理\"]\n    C --> D[\"测试边界情况\"]\n    D --> E[\"健壮的程序\"]\n```\n\n下一章，我们将进入**数据科学工具链**——接触真正的数据分析。\n\n",
    "supporting": [
      "07-errors_files"
    ],
    "filters": [],
    "includes": {}
  }
}