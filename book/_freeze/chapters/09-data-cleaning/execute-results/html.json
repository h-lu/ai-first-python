{
  "hash": "17ead725e04f87255d8a911b037179f7",
  "result": {
    "engine": "jupyter",
    "markdown": "# 数据清洗与预处理 {#sec-data-cleaning}\n\n::: {.callout-note}\n## 本章概要\n- **课时**：2课时（第9周）\n- **目标**：掌握数据清洗的核心概念和 Pandas 方法\n:::\n\n## 学习目标\n\n完成本章后，你将能够：\n\n1. 识别常见的数据质量问题\n2. 使用 Pandas 进行数据清洗\n3. 用 AI 生成清洗代码\n\n---\n\n## 现实数据是\"脏\"的\n\n```{mermaid}\nmindmap\n  root((Data Quality Issues))\n    Missing Values\n      Empty Cells\n      NA Markers\n      Placeholders\n    Outliers\n      Out of Range\n      Input Errors\n      Extremes\n    Inconsistency\n      Format Mismatch\n      Unit Difference\n      Naming Variance\n    Duplicates\n      Full Duplicate\n      Partial Duplicate\n      ID Duplicate\n```\n\n### 示例：杂乱的学生数据\n\n::: {#18251f25 .cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\n\n# 模拟\"脏\"数据\nmessy_data = pd.DataFrame({\n    '学号': ['001', '002', '003', '003', '004', '005', '006'],\n    '姓名': ['张三', '李四', None, '王五', '赵六', '孙七', '周八'],\n    '成绩': [85, 150, 78, 78, -5, None, 92],  # 150和-5是异常值\n    '班级': ['1班', '一班', '1班', '1班', '1 班', '1班', '01班'],  # 格式不一致\n    '入学日期': ['2024-09-01', '2024/9/1', '2024.9.1', '2024-09-01', None, '24-9-1', '2024-09-01']\n})\n\nprint(\"原始数据（有多种问题）:\")\nprint(messy_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n原始数据（有多种问题）:\n    学号    姓名     成绩   班级        入学日期\n0  001    张三   85.0   1班  2024-09-01\n1  002    李四  150.0   一班    2024/9/1\n2  003  None   78.0   1班    2024.9.1\n3  003    王五   78.0   1班  2024-09-01\n4  004    赵六   -5.0  1 班        None\n5  005    孙七    NaN   1班      24-9-1\n6  006    周八   92.0  01班  2024-09-01\n```\n:::\n:::\n\n\n---\n\n## 处理缺失值\n\n### 发现缺失值\n\n::: {#23f5dd72 .cell execution_count=2}\n``` {.python .cell-code}\n# 检查缺失值\nprint(\"缺失值统计:\")\nprint(messy_data.isnull().sum())\n\nprint(\"\\n缺失值占比:\")\nprint(messy_data.isnull().mean() * 100)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n缺失值统计:\n学号      0\n姓名      1\n成绩      1\n班级      0\n入学日期    1\ndtype: int64\n\n缺失值占比:\n学号       0.000000\n姓名      14.285714\n成绩      14.285714\n班级       0.000000\n入学日期    14.285714\ndtype: float64\n```\n:::\n:::\n\n\n### 处理策略\n\n```{mermaid}\nflowchart TD\n    A[\"发现缺失值\"] --> B{\"缺失多少?\"}\n    B -->|\"< 5%\"| C[\"删除或填充\"]\n    B -->|\"5-30%\"| D[\"智能填充\"]\n    B -->|\"> 30%\"| E[\"考虑删除该列\"]\n    \n    C --> C1[\"删除行: dropna()\"]\n    C --> C2[\"填充均值/中位数\"]\n    \n    D --> D1[\"用同组均值填充\"]\n    D --> D2[\"用前后值填充\"]\n    D --> D3[\"标记为缺失类别\"]\n```\n\n::: {#7d74b646 .cell execution_count=3}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\n\n# 创建示例数据\ndf = pd.DataFrame({\n    '姓名': ['张三', None, '王五', '赵六'],\n    '成绩': [85, 90, None, 88],\n    '年龄': [20, 21, None, 19]\n})\n\nprint(\"原始数据:\")\nprint(df)\n\n# 方法1：删除含缺失值的行\ndf_dropna = df.dropna()\nprint(\"\\n删除缺失值后:\")\nprint(df_dropna)\n\n# 方法2：填充固定值\ndf_fill = df.fillna({'姓名': '未知', '成绩': 0, '年龄': df['年龄'].mean()})\nprint(\"\\n填充后:\")\nprint(df_fill)\n\n# 方法3：用均值填充数值列\ndf_mean = df.copy()\ndf_mean['成绩'] = df_mean['成绩'].fillna(df_mean['成绩'].mean())\ndf_mean['年龄'] = df_mean['年龄'].fillna(df_mean['年龄'].median())\nprint(\"\\n均值/中位数填充后:\")\nprint(df_mean)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n原始数据:\n     姓名    成绩    年龄\n0    张三  85.0  20.0\n1  None  90.0  21.0\n2    王五   NaN   NaN\n3    赵六  88.0  19.0\n\n删除缺失值后:\n   姓名    成绩    年龄\n0  张三  85.0  20.0\n3  赵六  88.0  19.0\n\n填充后:\n   姓名    成绩    年龄\n0  张三  85.0  20.0\n1  未知  90.0  21.0\n2  王五   0.0  20.0\n3  赵六  88.0  19.0\n\n均值/中位数填充后:\n     姓名         成绩    年龄\n0    张三  85.000000  20.0\n1  None  90.000000  21.0\n2    王五  87.666667  20.0\n3    赵六  88.000000  19.0\n```\n:::\n:::\n\n\n---\n\n## 处理异常值\n\n### 发现异常值\n\n::: {#64d08b01 .cell execution_count=4}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\n\n# 示例数据\nscores = pd.Series([85, 92, 78, 150, 60, -5, 88, 95, 72, 300])\n\n# 方法1：范围检查\nprint(\"超出 0-100 的值:\")\nprint(scores[(scores < 0) | (scores > 100)])\n\n# 方法2：统计方法（3σ原则）\nmean = scores.mean()\nstd = scores.std()\noutliers = scores[(scores < mean - 3*std) | (scores > mean + 3*std)]\nprint(f\"\\n统计异常值（3σ）: {outliers.tolist()}\")\n\n# 方法3：四分位距法（IQR）\nQ1 = scores.quantile(0.25)\nQ3 = scores.quantile(0.75)\nIQR = Q3 - Q1\nlower = Q1 - 1.5 * IQR\nupper = Q3 + 1.5 * IQR\noutliers_iqr = scores[(scores < lower) | (scores > upper)]\nprint(f\"IQR异常值: {outliers_iqr.tolist()}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n超出 0-100 的值:\n3    150\n5     -5\n9    300\ndtype: int64\n\n统计异常值（3σ）: []\nIQR异常值: [150, -5, 300]\n```\n:::\n:::\n\n\n### 处理策略\n\n::: {#d18ba507 .cell execution_count=5}\n``` {.python .cell-code}\n# 原始数据\nscores = pd.Series([85, 92, 78, 150, 60, -5, 88, 95, 72, 300])\n\n# 方法1：删除异常值\nvalid_scores = scores[(scores >= 0) & (scores <= 100)]\nprint(f\"删除异常值: {valid_scores.tolist()}\")\n\n# 方法2：截断（Winsorize）\nclipped = scores.clip(lower=0, upper=100)\nprint(f\"截断处理: {clipped.tolist()}\")\n\n# 方法3：替换为 NaN，后续单独处理\nreplaced = scores.where((scores >= 0) & (scores <= 100), np.nan)\nprint(f\"替换为NaN: {replaced.tolist()}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n删除异常值: [85, 92, 78, 60, 88, 95, 72]\n截断处理: [85, 92, 78, 100, 60, 0, 88, 95, 72, 100]\n替换为NaN: [85.0, 92.0, 78.0, nan, 60.0, nan, 88.0, 95.0, 72.0, nan]\n```\n:::\n:::\n\n\n---\n\n## 统一数据格式\n\n### 日期格式统一\n\n::: {#1eba8714 .cell execution_count=6}\n``` {.python .cell-code}\nimport pandas as pd\n\n# 各种日期格式\ndates = pd.Series(['2024-09-01', '2024/9/1', '2024.9.1', '24-9-1', 'Sep 1, 2024'])\n\n# 统一转换\ntry:\n    unified = pd.to_datetime(dates, errors='coerce')\n    print(\"统一后的日期:\")\n    print(unified)\nexcept Exception as e:\n    print(f\"转换错误: {e}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n统一后的日期:\n0   2024-09-01\n1   2024-09-01\n2   2024-09-01\n3   2001-09-24\n4   2024-09-01\ndtype: datetime64[ns]\n```\n:::\n:::\n\n\n### 文本格式统一\n\n::: {#dc430721 .cell execution_count=7}\n``` {.python .cell-code}\nimport pandas as pd\n\n# 不一致的班级名称\nclasses = pd.Series(['1班', '一班', '1 班', '01班', ' 1班 ', '一 班'])\n\n# 文本清洗函数\ndef clean_class_name(name):\n    \"\"\"统一班级名称格式\"\"\"\n    if pd.isna(name):\n        return None\n    \n    # 去除空格\n    name = name.strip().replace(' ', '')\n    \n    # 中文数字转阿拉伯数字\n    cn_to_num = {'一': '1', '二': '2', '三': '3', '四': '4', '五': '5'}\n    for cn, num in cn_to_num.items():\n        name = name.replace(cn, num)\n    \n    # 去除前导零\n    name = name.lstrip('0')\n    \n    # 确保以\"班\"结尾\n    if not name.endswith('班'):\n        name = name + '班'\n    \n    return name\n\n# 应用清洗\ncleaned = classes.apply(clean_class_name)\nprint(\"清洗前后对比:\")\ncomparison = pd.DataFrame({'原始': classes, '清洗后': cleaned})\nprint(comparison)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n清洗前后对比:\n     原始 清洗后\n0    1班  1班\n1    一班  1班\n2   1 班  1班\n3   01班  1班\n4   1班   1班\n5   一 班  1班\n```\n:::\n:::\n\n\n---\n\n## 处理重复数据\n\n::: {#f3cfbf97 .cell execution_count=8}\n``` {.python .cell-code}\nimport pandas as pd\n\n# 示例数据（含重复）\ndf = pd.DataFrame({\n    '学号': ['001', '002', '002', '003', '003'],\n    '姓名': ['张三', '李四', '李四', '王五', '王五'],\n    '成绩': [85, 90, 90, 78, 80]  # 注意：002完全重复，003成绩不同\n})\n\nprint(\"原始数据:\")\nprint(df)\n\n# 检查重复\nprint(f\"\\n完全重复的行数: {df.duplicated().sum()}\")\nprint(f\"学号重复的行数: {df.duplicated(subset=['学号']).sum()}\")\n\n# 删除完全重复的行\ndf_no_dup = df.drop_duplicates()\nprint(\"\\n删除完全重复后:\")\nprint(df_no_dup)\n\n# 删除学号重复的行（保留第一个）\ndf_unique_id = df.drop_duplicates(subset=['学号'], keep='first')\nprint(\"\\n删除重复学号后（保留第一个）:\")\nprint(df_unique_id)\n\n# 删除学号重复的行（保留最后一个）\ndf_unique_id_last = df.drop_duplicates(subset=['学号'], keep='last')\nprint(\"\\n删除重复学号后（保留最后一个）:\")\nprint(df_unique_id_last)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n原始数据:\n    学号  姓名  成绩\n0  001  张三  85\n1  002  李四  90\n2  002  李四  90\n3  003  王五  78\n4  003  王五  80\n\n完全重复的行数: 1\n学号重复的行数: 2\n\n删除完全重复后:\n    学号  姓名  成绩\n0  001  张三  85\n1  002  李四  90\n3  003  王五  78\n4  003  王五  80\n\n删除重复学号后（保留第一个）:\n    学号  姓名  成绩\n0  001  张三  85\n1  002  李四  90\n3  003  王五  78\n\n删除重复学号后（保留最后一个）:\n    学号  姓名  成绩\n0  001  张三  85\n2  002  李四  90\n4  003  王五  80\n```\n:::\n:::\n\n\n---\n\n## 完整清洗流程\n\n```{mermaid}\nflowchart TD\n    A[\"原始数据\"] --> B[\"1. 查看数据概况\"]\n    B --> C[\"2. 处理重复值\"]\n    C --> D[\"3. 处理缺失值\"]\n    D --> E[\"4. 处理异常值\"]\n    E --> F[\"5. 统一格式\"]\n    F --> G[\"6. 验证数据质量\"]\n    G --> H[\"清洗后数据\"]\n```\n\n### 综合案例\n\n::: {#1d3496f4 .cell execution_count=9}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\n\ndef clean_student_data(df):\n    \"\"\"\n    清洗学生数据的完整流程\n    \n    Returns:\n        清洗后的 DataFrame 和清洗报告\n    \"\"\"\n    report = {\"原始行数\": len(df)}\n    df = df.copy()\n    \n    # 1. 删除完全重复的行\n    df = df.drop_duplicates()\n    report[\"删除完全重复后\"] = len(df)\n    \n    # 2. 删除重复学号（保留第一条）\n    df = df.drop_duplicates(subset=['学号'], keep='first')\n    report[\"删除重复学号后\"] = len(df)\n    \n    # 3. 处理成绩异常值：超出0-100的设为NaN\n    if '成绩' in df.columns:\n        invalid_mask = (df['成绩'] < 0) | (df['成绩'] > 100)\n        report[\"异常成绩数\"] = invalid_mask.sum()\n        df.loc[invalid_mask, '成绩'] = np.nan\n    \n    # 4. 填充缺失的成绩（用均值）\n    if '成绩' in df.columns:\n        mean_score = df['成绩'].mean()\n        df['成绩'] = df['成绩'].fillna(mean_score)\n    \n    # 5. 填充缺失的姓名\n    if '姓名' in df.columns:\n        df['姓名'] = df['姓名'].fillna('未知')\n    \n    report[\"最终行数\"] = len(df)\n    \n    return df, report\n\n# 测试\nmessy_data = pd.DataFrame({\n    '学号': ['001', '002', '003', '003', '004', '005'],\n    '姓名': ['张三', '李四', None, '王五', '赵六', '孙七'],\n    '成绩': [85, 150, 78, 78, -5, None]\n})\n\ncleaned_df, report = clean_student_data(messy_data)\n\nprint(\"清洗报告:\")\nfor key, value in report.items():\n    print(f\"  {key}: {value}\")\n\nprint(\"\\n清洗后数据:\")\nprint(cleaned_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n清洗报告:\n  原始行数: 6\n  删除完全重复后: 6\n  删除重复学号后: 5\n  异常成绩数: 2\n  最终行数: 5\n\n清洗后数据:\n    学号  姓名    成绩\n0  001  张三  85.0\n1  002  李四  81.5\n2  003  未知  78.0\n4  004  赵六  81.5\n5  005  孙七  81.5\n```\n:::\n:::\n\n\n---\n\n## 让 AI 帮你清洗数据\n\n### Prompt 模板\n\n```\n我有一个学生成绩数据集，请帮我清洗：\n\n数据问题：\n1. 有些成绩是负数或超过100\n2. 姓名有的是空值\n3. 班级格式不统一（1班、一班、01班）\n4. 有重复的学号\n\n请生成 Pandas 清洗代码，并：\n- 删除无法修复的异常值\n- 填充缺失值\n- 统一班级格式\n- 报告清洗前后的数据量变化\n```\n\n---\n\n## 课后作业\n\n### 继续作业 4：数据可视化仪表板\n\n**本周任务**：数据清洗\n\n1. 下载真实数据集（包含质量问题）\n2. 分析数据质量问题\n3. 编写清洗代码\n4. 生成清洗报告\n\n**REPORT.md 要求**：\n- 列出你发现的所有数据质量问题\n- 展示清洗前后的对比\n\n---\n\n## 本章小结\n\n- **数据质量问题**：缺失值、异常值、不一致、重复\n- **缺失值处理**：删除、填充（均值/中位数），取决于缺失比例\n- **异常值处理**：删除、截断、替换为 NaN\n- **格式统一**：`pd.to_datetime()`、自定义清洗函数\n- **重复处理**：`drop_duplicates()`\n- **清洗流程**：先看概况 → 去重 → 处理缺失 → 处理异常 → 统一格式 → 验证\n\n下一章，我们将学习**数据可视化**——用图表讲述数据故事。\n\n",
    "supporting": [
      "09-data-cleaning_files"
    ],
    "filters": [],
    "includes": {}
  }
}